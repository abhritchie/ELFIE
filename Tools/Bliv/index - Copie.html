<!DOCTYPE html>
<html>
<head>
	<title> Cartographie des unités hydrogéologiques </title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link rel="stylesheet" href="jQuery-ui/themes/base/jquery-ui.css" type="text/css">
	<link rel="stylesheet" href="Openlayers/theme/default/style.css" type="text/css">
	<style type="text/css">
		html,body { 
			width: 100%;
			height: 100%;;
		}
		#map {
			width: 98%;
            height: 98%;
			border: 1px solid black;
		}
		#popup{
			font-size: 14px;
		}
		#localisation{
			margin-bottom: 5px;
			width: 180px;
		}
		#locate{
			margin-right: 10px;
			float: right;
		}
	</style>
	<link rel="icon" type="image/ico" href="http://vmrd87.brgm.fr/datalift/images/semantic-web.ico"/>
	<link rel="stylesheet" type="text/css" href="http://vmrd87.brgm.fr/datalift/wro/main.css"/>
	<link rel="stylesheet" type="text/css" href="http://vmrd87.brgm.fr/datalift/sparql/viz/css/closeInterface.css"/>
	<link rel="stylesheet" type="text/css" href="http://vmrd87.brgm.fr/datalift/sparql/viz/css/form-select.css"/>
	<link rel="stylesheet" type="text/css" href="http://vmrd87.brgm.fr/datalift/sparql/viz/css/jquery.contextMenu.css"/>
	<link rel="stylesheet" type="text/css" href="http://vmrd87.brgm.fr/datalift/sparql/viz/css/leaflet/leaflet.css"/>
	<!--Open layer-->
	<link rel="stylesheet" type="text/css" href="http://vmrd87.brgm.fr/datalift/sparql/viz/css/ol.css"/>
	<!--Code mirror-->
	<link rel="stylesheet" type="text/css" href="http://vmrd87.brgm.fr/datalift/sparql/viz/css/codeMirror/codemirror.css"/>
	<link rel="stylesheet" type="text/css" href="http://vmrd87.brgm.fr/datalift/sparql/viz/css/codeMirror/xq-light.css"/>

<script type="text/javascript" src="http://api.ign.fr/geoportail/api/js/2.0.3/GeoportalExtended.js"></script>
<script src='./Openlayers/infoFormat3.js'></script>
<script src='./Openlayers/infoFormat2.js'></script>
<script src='./Openlayers/infoFormat.js'></script>
<script src='./jQuery/jquery-2.0.0.js'></script>
<script src='./jQuery-ui/ui/jquery-ui.js'></script>
<!-- Library ol javascript -->
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/ol.js"></script>
	<!-- JQuery + JQuery UI -->
	<!--<script language="javascript" src="http://vmrd87.brgm.fr/datalift/js/jquery/jquery.js"></script>-->
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/contextMenu/jquery-1.8.2.min.js"></script>
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/js/jquery/jquery-ui.js"></script>
	<!-- JQuery Plugins -->
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/js/jquery/jquery.jqGrid.locale-en.js"></script>
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/js/jquery/jquery.jqGrid.js"></script>
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/js/jquery/jquery.history.js"></script>
	<!-- Datalift common javascript -->
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/js/common.js"></script>
	<!-- Library highchartJS javascript -->
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/highchart/highcharts.js"></script>
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/highchart/highcharts-more.js"></script>
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/highchart/exporting.js"></script>
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/highchart/highcharts-3d.js"></script>
		<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/highchart/treemap.js"></script>
	<!-- AngularJs javascript -->
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/angular.min.js"></script>
	<!-- Directive else if for AngularJs javascript -->
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/elif.js"></script>
	<!-- Sgvizler javascript -->
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/sgvizler_js/jsapi.js"></script>
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/sgvizler_js/sgvizler.js"></script>
	<!-- jQuery contextMenu javascript -->
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/contextMenu/jquery.ui.position.js"></script>
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/contextMenu/jquery.contextMenu.js"></script>
	<!-- Library JQuery javascript -->
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/js/jquery/jquery.js"></script>
	<!-- Bridge for executing contextMenu javascript -->
	<!--<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/executeContextMenu.js"></script>
	 Library Leaflet javascript -->
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/leaflet/leaflet.js"></script>
	<!-- Library Wicket (transorm WKT) javascript -->
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/wicket/wicket.js"></script>
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/wicket/wicket-leaflet.js"></script>
	<!-- Library codemirror javascript -->
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/codeMirror/codemirror.js"></script>
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/codeMirror/matchbrackets.js"></script>
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/codeMirror/sparql.js"></script>
	<!-- interface for legacy visu javascript -->
	<script language="javascript" src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/legacy-visu.js"></script>

	<!-- <script src="http://vmrd87.brgm.fr/datalift/sparql/viz/js/mapline.js"></script> -->
	<script src="http://vmrd87.brgm.fr/datalift/sparql/save-request/mapline.js"></script>
<script type="text/javascript">
function launchOL(){
			var q = getSPARQLRequest2();
			var sel = "internal";
			$.ajax({
				url : 'http://vmrd87.brgm.fr/datalift/sparql',
				type : 'GET',
				data : {
					'default-graph-uri' : sel,
					'query' : q,
				},
				dataType : 'json',
				error : function(result, status, error){
					if(getLang()=="EN"){
						alert("Failure to recovery parameters");
					} else {
						alert("Echec de récupération des paramètres");
					}
				},
				success : function(json, status){
					visu.createContainer("graphs_get_description", "map");
					execute(json);
				}
			});	
		}
		
		
function execute(data){
	(function(){
		var WKT = []; // Array contains lists of all WKT polygons extrated from SPARQL request
		var labels = []; // Array contains lists of all labels polygons extrated from SPARQL request
		var colorSelect = "#4ff7f7";
		var varNames = [];
		if(data.results.bindings.length==0) {
			alert("no results to show");
		} else {
			varNames = data.head.vars;
			$.each(data.results.bindings, function(key, val) {	
				if (val[varNames[0]]['value']=="http://vmrd87.brgm.fr/id/bdlisa/st-astext")
				{
				WKT.push(val[varNames[1]]['value']);
				labels.push(getSPARQLRequest());
				}
			});
		}
		
		// Map configuration
		var map = L.map('map').setView([0, 0], 10);
		// Add map box tile
		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
			maxZoom: 18,
			id: 'dlift.b4e0fe33',
			accessToken: 'pk.eyJ1IjoiZGxpZnQiLCJhIjoiMGRhOTQyM2NmNjkyN2E5ZDliYjdlYjhmZjk0MmRkMzQifQ.Jr2TI6X6zPRjpQAsYhX_PQ'
		}).addTo(map);
		
		//Create feature group
		var fGroup = new L.featureGroup();
		//Iterate dynamicly in all present polygons
		$.each(WKT,function(index,value){
			var feature = transformToGeoJson(value, fGroup, map);
			feature.bindPopup(labels[index]);
		});
		fGroup.addTo(map); // Add it to the map
		
		// bounds map on layers
		//map.fitBounds(fGroup.getBounds(), {padding: [0,0]});
		//Function to transformate WKT geometries to GeoJson
		function transformToGeoJson(WKT, fGroup, map) {
			var wkt = new Wkt.Wkt();
			// Read wkt
			try { // Catch any malformed WKT strings
                wkt.read(WKT);
            } catch (e1) {
                try {
                    wkt.read(WKT.replace('\n', '').replace('\r', '').replace('\t', ''));
                } catch (e2) {
                    if (e2.name === 'WKTError') {
                        console.log('Could not understand the WKT string. Check that you have parentheses balanced, and try removing tabs and newline characters.');
                        return;
                    }
                }
            }
			// Convert to object
			var obj = wkt.toObject({
                icon: new L.Icon({
                    iconUrl: 'red_dot.png',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8],
                    shadowUrl: 'dot_shadow.png',
                    shadowSize: [16, 16],
                    shadowAnchor: [8, 8]
                }),
                editable: true,
                color: '#AA0000',
                weight: 3,
                opacity: 1.0,
                editable: true,
                fillColor: '#AA0000',
                fillOpacity: 0.2
            });
			
			// Draw geometries
            if (Wkt.isArray(obj)) { // Distinguish multigeometries (Arrays) from objects
                for (i in obj) {
                    if (obj.hasOwnProperty(i) && !Wkt.isArray(obj[i])) {
						obj[i].addTo(map);
						fGroup.addLayer(obj[i]);
                    }
                }
            } else {
				obj.addTo(map);
				fGroup.addLayer(obj);
            }
			return obj;
		}
	})();
}	

function getSPARQLRequest() {
			return document.getElementById("query").value;
		}
function getSPARQLRequest2() {
			var resource= document.getElementById("query").value;
			return "select ?p ?o where { <"+resource+"> ?p ?o .}"
		}	
	
</script>
</head>
<body >
	
	<div id="content" class="ui-widget-content dl-main-panel">
				<div class="dl-panel">
					   
				
			
						<div style="width:100%;margin-bottom:2px;">
							<p></p>
								<textarea id="query" name="query" spellcheck="false"></textarea>
						</div>


						<div style="height:40px;width:100%;margin-top:4px;">
				<div style="height:30px;float:left;margin:auto;">
				</div>
				<div style="height:30px;float:right;margin:auto;">
					<button onclick="launchOL()" id="query_submit" value=" " style="background-image:url('http://vmrd87.brgm.fr/datalift/sparql/viz/images/icons/run.png');background-repeat:no-repeat;margin:2px;width:40px;height:40px;" title="Exécuter la requête"/>
				</div>
			</div>
		    
		</div>
		

				
	
	<div id="graphs_show_description" class="ui-widget-content dl-main-panel" style=" height: 700px;">
		
		<div style="width:90%;margin:auto;">
			<div id="graphs_get_description" style="width:100%;height:660px;border:1px solid #a6c9e2;max-height:660px;">
			
		</div>
		<div style="height:20px;">
			<div style="width:18px;height:18px;float:left;margin-left:10px;">
			</div>
		</div>
	</div>
	</div>

	
</body>
</html>
